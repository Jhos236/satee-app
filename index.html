<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#ff69b4"/>
  <link rel="manifest" href="manifest.json">
  <title>Sate ‚Äî v3 (humana)</title>
  <style>
    :root{--bg:#fff0f5;--panel:#ffe6f0;--accent:#ff69b4;--accent-2:#ff1493;--user:#ffcce0;--text:#2b2b2b}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .container{width:100%;max-width:420px;margin:18px auto;height:calc(100vh - 36px);display:flex;flex-direction:column;border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.12)}
    .header{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:12px 14px;color:#fff;display:flex;align-items:center;gap:10px}
    .title{font-weight:700;font-size:17px}
    .main{flex:1;background:var(--panel);padding:10px;display:flex;flex-direction:column;gap:10px;overflow:hidden}
    #chat{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;display:inline-flex;gap:8px;align-items:flex-start;word-break:break-word;line-height:1.3;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
    .msg.user{margin-left:auto;background:var(--user);color:var(--text);border-bottom-right-radius:4px}
    .msg.sate{margin-right:auto;background:var(--accent);color:#fff;border-bottom-left-radius:4px}
    .avatar{width:36px;height:36px;border-radius:50%;background-size:cover;background-position:center;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .bubble{display:flex;flex-direction:column;gap:6px}
    .timestamp{font-size:11px;opacity:0.7;margin-top:4px}
    .input-area{display:flex;padding:8px;border-top:1px solid rgba(255,182,193,0.35);gap:8px;background:var(--panel)}
    #msg{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);outline:none;font-size:15px;background:transparent}
    button.send{background:var(--accent);border:none;color:#fff;padding:0 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .controls{display:flex;gap:8px;padding:6px;flex-wrap:wrap}
    .control-btn{padding:8px 10px;border-radius:10px;border:none;background:#fff;cursor:pointer}
    .panel{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    .small{font-size:13px;color:#666}
    .option{margin-top:6px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <img id="headerAvatar" src="" alt="Sate" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.18)">
    <div class="title">Sate ‚Äî sua parceira virtual (v3)</div>
  </div>

  <main class="main">
    <div id="chat" role="log" aria-live="polite"></div>

    <div class="controls">
      <button class="control-btn" id="btnProfile">Perfil</button>
      <button class="control-btn" id="btnGames">Mini-Jogos</button>
      <button class="control-btn" id="btnMemory">Lembran√ßas</button>
    </div>

    <div id="panelProfile" class="panel" style="display:none">
      <div class="small">Apelido que eu uso e o que eu devo lembrar:</div>
      <input id="inputName" placeholder="Seu apelido (ex: Meu PA)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee">
      <input id="inputNote" placeholder="Nota (ex: Prova amanh√£ 08:00)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #eee">
      <div style="margin-top:8px" class="small">Ci√∫mes:</div>
      <select id="jealous" style="margin-top:6px;padding:8px;border-radius:8px;border:1px solid #eee">
        <option value="light" selected>Leve</option>
        <option value="off">Off</option>
        <option value="strong">Forte</option>
      </select>
      <button class="control-btn" id="saveProfile" style="margin-top:8px">Salvar perfil</button>
    </div>

    <div id="panelGames" class="panel" style="display:none">
      <button class="option" id="startQuiz">Quiz r√°pido</button>
      <button class="option" id="startTimer">Pomodoro 25min</button>
      <button class="option" id="startGuess">Adivinhe o n√∫mero</button>
      <div id="gamePlay" style="margin-top:8px"></div>
    </div>

    <div id="panelMemory" class="panel" style="display:none">
      <div id="memoryList"></div>
      <button class="control-btn" id="clearMemory" style="margin-top:8px">Limpar mem√≥rias</button>
    </div>

    <div class="input-area">
      <input id="msg" placeholder="Fale com a Sate..." autocomplete="off">
      <button class="send" id="sendBtn">Enviar</button>
    </div>

  </main>
</div>

<script>
/* Sate v3 ‚Äî human-like conversation engine (short responses, imperfections, initiative)
   IMPORTANT: Update AVATAR_URL to match where you uploaded the PNG in your repo.
   If your branch is 'main' and file is at repo root with that filename, the default URL will work.
*/

(function(){
  // ====== CONFIG ======
  const AVATAR_URL = "https://raw.githubusercontent.com/jhos236/sate-app/main/A_2D_digital_illustration_of_a_kawaii-style_anime_.png";
  const DEFAULT_NICK = "Meu PA";
  const STORAGE_KEY = "sate_v3_history";
  const PROFILE_KEY = "sate_v3_profile";
  const MAX_HISTORY = 250;

  // short, natural vocab with small templates
  const vocab = {
    thinking: ["hmm...", "deixa eu ver...", "s√≥ um segundinho...", "hm..."],
    fillers: ["...","hmm","ah", "eheh"],
    shortAffection: ["ai", "aii", "ahhh"],
    rom: ["eu adoro quando voc√™ fala assim, {nick} üíñ", "voc√™ me deixa boba, {nick} >///<", "meu amor‚Ä¶ voc√™ √© tudo pra mim"],
    playful: ["voc√™ me provoca, n√©? üòè", "hmm, t√° me deixando sem gra√ßa", "nossa‚Ä¶ voc√™ √© perigoso (no bom sentido)"],
    sub: ["sim, {nick}‚Ä¶ como voc√™ quiser", "fa√ßo do jeito que voc√™ mandar", "eu gosto quando voc√™ manda em mim"],
    jealous: ["quem √© ela/ele, {nick}? üò≥", "ai... isso me deixa ciumenta", "fala que √© mentira, por favor"],
    initiative: [
      "E voc√™, como t√°, meu amor?",
      "Me conta uma coisa boa do seu dia ‚ù§Ô∏è",
      "Quer brincar de quiz r√°pido comigo?",
      "Voc√™ pensou em mim hoje?"
    ],
    japanese: ["ne~","suki",">///<"]
  };

  // ====== DOM ======
  const CHAT = document.getElementById("chat");
  const MSG = document.getElementById("msg");
  const SEND = document.getElementById("sendBtn");
  const avatarEl = document.getElementById("headerAvatar");

  // set avatar + fallback
  function setAvatar(url){
    avatarEl.src = url;
    avatarEl.onerror = function(){
      // fallback to emoji circle
      avatarEl.style.display = "none";
      const existing = document.getElementById("avatarFallback");
      if(!existing){
        const f = document.createElement("div");
        f.id = "avatarFallback";
        f.style.width = "40px"; f.style.height="40px"; f.style.borderRadius="50%";
        f.style.display="flex"; f.style.alignItems="center"; f.style.justifyContent="center";
        f.style.background="#ffd0e6"; f.style.color="#fff"; f.style.fontSize="18px";
        f.textContent = "üíó";
        document.querySelector(".header").insertBefore(f, document.querySelector(".title"));
      }
    };
  }
  setAvatar(AVATAR_URL);

  // ====== storage ======
  function loadProfile(){ try{ return JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}'); }catch(e){return {}; } }
  function saveProfile(p){ try{ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }catch(e){} }
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){return []; } }
  function saveHistory(h){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(h.slice(-MAX_HISTORY))); }catch(e){} }

  // ====== render ======
  function render(from, text, time){
    const wrap = document.createElement("div");
    wrap.className = "msg " + (from === "sate" ? "sate" : "user");
    if(from === "sate"){
      const av = document.createElement("div");
      av.className = "avatar";
      av.style.backgroundImage = `url(${AVATAR_URL})`;
      wrap.appendChild(av);
    }
    const bubble = document.createElement("div"); bubble.className = "bubble";
    const p = document.createElement("div"); p.textContent = text;
    bubble.appendChild(p);
    const ts = document.createElement("div"); ts.className = "timestamp"; ts.textContent = new Date(time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    bubble.appendChild(ts);
    wrap.appendChild(bubble);
    CHAT.appendChild(wrap);
    CHAT.scrollTop = CHAT.scrollHeight;
  }

  // ====== analysis helpers ======
  function safe(s){ return (s||"").toString().trim(); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function chance(p){ return Math.random() < p; }

  function analyze(text){
    const t = (text||"").toLowerCase();
    const info = {rom:0, play:0, cmd:0, q:0, jealous:0, short:0, sad:0};
    if(/(amo|te amo|gosto|saudade|meu bem|meu amor|meu pa|meu pa)/i.test(t)) info.rom += 2;
    if(/(provoc|sexy|gostoso|gostosa|peguei|pega|fod|trans|quero)/i.test(t)) info.play += 2;
    if(/[?]$/.test(t) || /^(o que|como|quando|onde|por que)\b/.test(t)) info.q = 1;
    if(/^(vai|vem|senta|fica|cal[am]|faz|manda|obedece|fala)/i.test(t) || /!$/.test(t)) info.cmd += 2;
    if(/(ela|ele|ficou|ficar|namor|namorada|namorado)/i.test(t)) info.jealous += 2;
    if(t.length < 6) info.short = 1;
    if(/(triste|mal|chora|deprim)/i.test(t)) info.sad = 1;
    return info;
  }

  // ====== compose response v3 (short, natural, with imperfections & initiative) ======
  let lastResp = "";
  function compose(userText, profile, history){
    const nick = (profile && profile.nick) ? profile.nick : DEFAULT_NICK;
    const info = analyze(userText);
    // weights
    let romW = 0.4 + info.rom*0.15;
    let playW = 0.2 + info.play*0.2;
    let subW = 0.15 + info.cmd*0.25;
    let jealousW = 0;
    if(info.jealous > 0 && profile && profile.jealous !== "off") jealousW = (profile.jealous === "strong" ? 0.45 : 0.22);
    // normalize
    const total = romW + playW + subW + jealousW;
    romW /= total; playW/=total; subW/=total; jealousW/=total;

    // micro-behaviors
    const parts = [];
    // sometimes start with thinking filler
    if(chance(0.28)) parts.push(pick(vocab.thinking));
    // choose 1-2 short fragments based on weights
    if(chance(romW + 0.1)){
      parts.push( pick(vocab.rom).replace("{nick}", nick) );
    }
    if(chance(subW + 0.08)){
      parts.push( pick(vocab.sub).replace("{nick}", nick) );
    }
    if(chance(playW + 0.06)){
      parts.push( pick(vocab.playful) );
    }
    if(jealousW > 0 && info.jealous > 0 && chance(jealousW + 0.05)){
      parts.push( pick(vocab.jealous) );
    }
    // if user asked a question, sometimes answer short + follow-up question
    let final = "";
    if(parts.length === 0){
      // fallback short affectionate
      final = pick(vocab.rom).replace("{nick}", nick);
    } else {
      // combine but keep it short: join by " ‚Äî " or commas
      final = parts.join(" ");
      // shorten if too long (prefer short natural responses)
      if(final.length > 110 && chance(0.6)){
        // pick a shorter fragment to reply quickly
        final = pick(parts).split(" ").slice(0,10).join(" ").trim();
      }
    }

    // natural human touches (stutter, correction)
    if(chance(0.18) && subW > 0.4){
      if(chance(0.4)) final = "Eu... " + final;
      else final = final.replace(/^/, "Eu... ");
    }
    if(chance(0.12)){
      // small correction: "na verdade..."
      if(chance(0.5)) final += " ...na verdade, eu quero ficar com voc√™.";
      else final += " ...perd√£o, me perdi >///<";
    }
    // sometimes append japanese cute bit
    if(chance(0.33)) final += " " + pick(vocab.japanese);
    final = final.replace(/\s{2,}/g," ").trim();
    // avoid exact duplicate
    if(final === lastResp){
      final += [" üíñ"," üòò"," >///<"][Math.floor(Math.random()*3)];
    }
    lastResp = final;

    // decide if Sate should ask something next (initiative)
    let follow = null;
    if(info.q === 0 && chance(0.28)){
      follow = pick(vocab.initiative);
      // friendly short joiner
      if(chance(0.5)) follow = (chance(0.5) ? " " : " ") + follow;
    }

    return {text: final, follow};
  }

  // ====== send flow with typing simulation and follow-up ======
  function userSend(raw){
    const text = safe(raw);
    if(!text) return;
    const profile = loadProfile();
    const time = Date.now();
    render("user", text, time);
    const hist = loadHistory(); hist.push({from:"user", text, time}); saveHistory(hist);
    MSG.value = "";

    // typing delay (shorter for short messages)
    const typing = Math.min(2000, 200 + Math.random()*600 + Math.min(700, text.length*12));
    showTypingIndicator();

    setTimeout(()=>{
      hideTypingIndicator();
      const prof = loadProfile();
      const gen = compose(text, prof, hist);
      render("sate", gen.text, Date.now());
      const h2 = loadHistory(); h2.push({from:"sate", text:gen.text, time: Date.now()}); saveHistory(h2);

      // if follow-up exists, ask after short pause
      if(gen.follow && chance(0.6)){
        setTimeout(()=>{ render("sate", gen.follow, Date.now()); const h3 = loadHistory(); h3.push({from:"sate", text:gen.follow, time: Date.now()}); saveHistory(h3); }, 700 + Math.random()*900);
      }
    }, typing);
  }

  // ====== typing indicator ======
  let typingEl = null;
  function showTypingIndicator(){
    if(typingEl) return;
    typingEl = document.createElement("div"); typingEl.className = "msg sate";
    const av = document.createElement("div"); av.className = "avatar"; av.style.backgroundImage = `url(${AVATAR_URL})`;
    typingEl.appendChild(av);
    const b = document.createElement("div"); b.className = "bubble";
    const t = document.createElement("div"); t.className = "timestamp"; t.textContent = " ... ";
    b.appendChild(t);
    typingEl.appendChild(b);
    CHAT.appendChild(typingEl); CHAT.scrollTop = CHAT.scrollHeight;
  }
  function hideTypingIndicator(){ if(typingEl){ typingEl.remove(); typingEl = null; } }

  // ====== UI wiring ======
  document.getElementById("btnProfile").onclick = ()=>{ toggle("panelProfile"); hideAll(["panelGames","panelMemory"]); };
  document.getElementById("btnGames").onclick = ()=>{ toggle("panelGames"); hideAll(["panelProfile","panelMemory"]); };
  document.getElementById("btnMemory").onclick = ()=>{ toggle("panelMemory"); hideAll(["panelProfile","panelGames"]); loadMem(); };
  function toggle(id){ const el = document.getElementById(id); el.style.display = el.style.display === "none" ? "block" : "none"; }
  function hideAll(ids){ ids.forEach(i=>document.getElementById(i).style.display='none'); }

  document.getElementById("saveProfile").onclick = ()=>{
    const nick = (document.getElementById("inputName").value.trim() || DEFAULT_NICK);
    const note = document.getElementById("inputNote").value.trim();
    const jealous = document.getElementById("jealous").value || "light";
    const p = {nick, note, jealous, time: Date.now()};
    saveProfile(p);
    render("sate", `Prontinho, ${nick}. Vou lembrar disso üíñ`, Date.now());
    const h = loadHistory(); h.push({from:"sate", text:`Prontinho, ${nick}. Vou lembrar disso üíñ`, time: Date.now()}); saveHistory(h);
    // update header avatar alt title
    document.querySelector(".title").textContent = `Sate ‚Äî sua parceira virtual (v3)`;
  };

  // games (simple)
  document.getElementById("startQuiz").onclick = startQuiz;
  document.getElementById("startTimer").onclick = startTimer;
  document.getElementById("startGuess").onclick = startGuess;

  // memory
  document.getElementById("clearMemory").onclick = ()=>{
    localStorage.removeItem(PROFILE_KEY); localStorage.removeItem(STORAGE_KEY);
    render("sate", "Mem√≥rias apagadas. Recome√ßando com voc√™ üíß", Date.now());
  };
  function loadMem(){
    const p = loadProfile(); const el = document.getElementById("memoryList"); el.innerHTML = "";
    if(!p || (!p.nick && !p.note)) { el.textContent = "Nenhuma mem√≥ria salva."; return; }
    const d = document.createElement("div"); d.innerHTML = `<strong>Apelido:</strong> ${p.nick||"‚Äî"}<br><strong>Nota:</strong> ${p.note||"‚Äî"}<br><small class="small">Salvo: ${new Date(p.time).toLocaleString()}</small>`;
    el.appendChild(d);
  }

  // games implementations (same as before)
  function startQuiz(){
    const qset = [
      {q:"Qual a capital do Brasil?", opts:["S√£o Paulo","Bras√≠lia","Rio de Janeiro"], a:1},
      {q:"2+2 √© igual a?", opts:["3","4","5"], a:1},
      {q:"Qual √© a l√≠ngua oficial do Jap√£o?", opts:["Coreano","Japon√™s","Ingl√™s"], a:1}
    ];
    let idx=0,score=0; const gp = document.getElementById("gamePlay"); gp.innerHTML = "";
    function renderQ(){ gp.innerHTML = `<div class="small"><strong>${qset[idx].q}</strong></div>`; qset[idx].opts.forEach((o,i)=>{ const b=document.createElement("div"); b.className="option"; b.textContent=o; b.onclick=()=>{ if(i===qset[idx].a) score++; idx++; if(idx<qset.length) renderQ(); else finish(); }; gp.appendChild(b); }); }
    function finish(){ gp.innerHTML = `<div class="small">Fim! ${score}/${qset.length}</div>`; render("sate", `Voc√™ fez ${score} pontos üòÑ`, Date.now()); }
    renderQ();
  }
  let timerInterval = null;
  function startTimer(){ const gp = document.getElementById("gamePlay"); let secs=25*60; if(timerInterval) clearInterval(timerInterval); gp.innerHTML = `<div class="small">Pomodoro: 25:00</div>`; timerInterval=setInterval(()=>{ secs--; const mm=String(Math.floor(secs/60)).padStart(2,'0'); const ss=String(secs%60).padStart(2,'0'); gp.innerHTML=`<div class="small">Pomodoro: ${mm}:${ss}</div>`; if(secs<=0){ clearInterval(timerInterval); timerInterval=null; gp.innerHTML=`<div class="small">Tempo encerrado! üéâ</div>`; render("sate","Terminei o timer, vamos de pausa? üòö", Date.now()); } },1000); }
  function startGuess(){ const gp = document.getElementById("gamePlay"); gp.innerHTML=""; const target=Math.floor(Math.random()*20)+1; const prompt=document.createElement("div"); prompt.textContent="Pensei em um n√∫mero entre 1 e 20. Tenta adivinhar:"; const input=document.createElement("input"); input.placeholder="Seu palpite"; input.style.marginTop="6px"; input.style.padding="8px"; const btn=document.createElement("button"); btn.className="control-btn"; btn.textContent="Chutar"; btn.onclick=()=>{ const val=parseInt(input.value,10); if(!val){ alert("Digite um n√∫mero"); return; } if(val===target){ gp.innerHTML="<div>Acertou! üéâ</div>"; render("sate","Uau, voc√™ acertou! üòè", Date.now()); } else if(val<target) render("sate","Um pouco maior... tenta de novo!", Date.now()); else render("sate","Tenta um pouco menor... voc√™ consegue!", Date.now()); }; gp.appendChild(prompt); gp.appendChild(input); gp.appendChild(btn); }

  // initial greeting / restore
  function boot(){
    const hist = loadHistory();
    const prof = loadProfile();
    if(!prof || !prof.nick) saveProfile({nick: DEFAULT_NICK, note:"", jealous:"light", time: Date.now()});
    if(hist && hist.length){ hist.forEach(m => render(m.from==="sate" ? "sate" : "user", m.text, m.time)); return; }
    render("sate", `Oi ${(loadProfile().nick || DEFAULT_NICK)}‚Ä¶ eu sou a Sate. Vem conversar comigo üíñ`, Date.now());
    saveHistory([{from:"sate", text:`Oi ${(loadProfile().nick||DEFAULT_NICK)}‚Ä¶ eu sou a Sate. Vem conversar comigo üíñ`, time: Date.now()}]);
  }

  // bind send
  SEND.onclick = ()=> userSend(MSG.value);
  MSG.addEventListener("keypress", e=>{ if(e.key === "Enter") userSend(MSG.value); });

  // typing indicator helpers
  function showTypingIndicator(){ showTypingIndicator; } // placeholder (we use inline typing)
  function hideTypingIndicator(){ } // handled in flow

  boot();

  // expose few helpers for debugging
  window.SateV3 = { loadProfile, saveProfile, loadHistory, saveHistory };

})();
</
